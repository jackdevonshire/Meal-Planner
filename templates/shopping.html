{% extends "base.html" %}

{% block title %}Meal Planner {% endblock %}

{% block content %}
<div class="content">
   <div class="container">
      <div class="row">
         <div class="col-md-12 page-header">
            <h2></h2>
         </div>
      </div>
      <div class="container">
         <div class="page-title">
            <h3>Planned Meals</h3>
         </div>
         <div class="box box-primary">
            <div class="box-body">
               <div id="dataTables-example_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
                  <div class="row">
                     <div class="col-sm-12">
                        <table width="100%" class="table table-hover dataTable no-footer dtr-inline" id="dataTables-example" role="grid" aria-describedby="dataTables-example_info" style="width: 100%;">
                           <thead>
                             <th>Name</th>
                             <th>Source</th>
                             <th>Prep Time</th>
                             <th>Total Time</th>
                             <th></th>
                           </thead>
                           <tbody>
                              {% for recipe in data['Recipes'] %}
                                 <tr class="odd">
                                    <td>{{recipe['Name']}}</td>
                                    <td>{{recipe['Source']}}</td>
                                    <td>{{recipe['PrepTime']}}</td>
                                    <td>{{recipe['TotalTime']}}</td>
                                    <td class="text-end">
                                        <button onclick="removeFromCart({{recipe['Id']}})" class="btn btn-outline-danger btn-rounded"><i class="fas fa-trash"></i></button>
                                    </td>
                                 </tr>
                              {% endfor %}
                              <tr class="odd">
                                 <td>
                                    <select id="recipe-select" style="width: 100%">
                                       <option></option>
                                       {% for recipe in data['AllRecipes'] %}
                                          <option value="{{recipe['Id']}}">{{recipe['Name']}}</option>
                                       {% endfor %}
                                    </select>
                                 </td>
                                 <td></td>
                                 <td></td>
                                 <td></td>
                                 <td class="text-end">
                                     <button onclick="addToCart()" class="btn btn-outline-info btn-rounded"><i class="fas fa-plus"></i> Add to cart</button>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>


   <div class="container">
      <div class="row">
         <div class="col-md-12 page-header">
            <h2></h2>
         </div>
      </div>
      <div class="container">
         <div class="page-title">
            <h3>Shopping List</h3>
         </div>
         <div class="box box-primary">
            <div class="box-body">
               <table class="table">
                 <thead>
                     <tr>
                         <th></th>
                         <th></th>
                         <th></th>
                     </tr>
                 </thead>
                 <tbody>
                  {% for category, ingredients in data["Ingredients"].items() %}
                  {% if ingredients|length > 0 %}
                  <tr>
                     <h4>
                        <td colspan="3">
                           <h4>{{category}}</h4>
                        </td>
                     </h4>
                  </tr>
                  {% for ingredient in ingredients %}
                  <tr>
                      <td>{{ingredient["Name"]}}</td>
                      <td>{{ingredient["Amount"]}} <small>{{ingredient["Unit"]}}</small></td>
                      <td>{{ingredient["Required"]}}</td>
                  </tr>
                  {% endfor %}
                  {% endif %}
                  {% endfor %}
                 </tbody>
             </table>
            </div>
         </div>
      </div>
   </div>
</div>




<script>
    // Initialize select2
    $(document).ready(function() {
        // Initialize the select2 dropdown
        $('#recipe-select').select2({
            placeholder: "Select a recipe",
            allowClear: true
        });
    });

    async function removeFromCart(recipeId) {
       try {
           const response = await fetch('/api/cart/' + recipeId, {
               method: 'DELETE',
               headers: {
                   'Content-Type': 'application/json'
               }
           });

           const result = await response.json();

           if (response.ok) {
               location.reload(); // Refresh page to update the table
           } else {
               alert("Error: " + result.error);
           }
       } catch (error) {
           console.error("Failed to delete recipe:", error);
       }
    }

    async function addToCart() {
        var selectedRecipeId = $('#recipe-select').val();
        if (!selectedRecipeId) {
         return;
        }

       try {
           const response = await fetch('/api/cart/' + selectedRecipeId, {
               method: 'PUT',
               headers: {
                   'Content-Type': 'application/json'
               }
           });

           const result = await response.json();

           if (response.ok) {
               location.reload(); // Refresh page to update the table
           } else {
               alert("Error: " + result.error);
           }
       } catch (error) {
           console.error("Failed to add recipe:", error);
       }
    }
</script>

{% endblock %}